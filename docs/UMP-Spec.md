# UMP仕様

- TCPを介した通信
- 使用コードはASCIIのみ。大文字小文字は区別する。コマンドは小文字
- プレイヤーの名前など、ASCIIで入らない場合はUTF-8をURIエンコードしたものを使う
- やりとりは、基本的にサーバからクライアントへ送り、一部コマンド(hello/sutehai?/naku?/tenpai?)はクライアントから返答を返す
- クライアントから任意のタイミングでサーバにコマンドは送らない

## 牌の表記

- 数字1文字+アルファベット1文字で一つの牌を表す。
- アルファベットはm(マンズ)、p(ピンズ)、s(ソウズ)、z(字牌)
- 字牌は東南西北白発中の順に1z〜7z
- アルファベット大文字はドラ(赤牌)
- 伏せ牌はxx(他家の配牌やツモ)

## 手牌の表記

- 基本的には理牌(ソート)して表記。順番はm<p<s<z、1<9
- 面前部分は普通に牌を並べ、晒した牌は<>で囲む。暗カンは()
    - 加槓のopenは刻子を[]で囲む
- スベースは空けない
- 例
    - 4m4m6m7m5p6p7p2s3s4s5s6s7s
    - 2m2m5z5z5z7z7z<2p3p4p><6z6z6z>

## プレイヤー(席)の表記

- 起家から順に、A0、B0、C0...Z0、A1、B1...と表記する

## ラウンド

- 親が1巡するまでを1ラウンドと呼ぶ
- ラウンドは0から始まる
- 東風線はラウンド0のみ、東南戦はラウンド0、ラウンド1の2ラウンド

## コマンド形式

- <シリアル番号> <コマンド> [<引数> ...] [<オプション> ...] <CR+LF>
- サーバから送られたコマンドに返答するときには、同じシリアル番号を送る
- セパレータは空白1文字
- オプションは<名前>=<値>の形式

## コマンド一覧

|サーバ|クライアント|説明|
|:--|:--|:--|
|hello [<オプション> ...]|hello [<オプション> ...]|接続確認。オプションについては後述|
|error <メッセージ>| |エラーメッセージを送る(認証失敗等)|
|seat gameid=<ゲームID> <席>||席を通知する|
|player <席> <名前>||プレイヤーが接続した|
|gamestart||ゲーム(半荘)開始|
|gameend <プレイヤー> <点数> ... | |ゲーム終了。着順にプレイヤーと点数を送る|
|kyokustart <ラウンド> <親> <本場> <供託> <場風> <席風>...| |一局が始まるときに送る。席風は起家から順にプレイヤー分続く|
|kyokuend | |一局終了 |
|ready? |yes|クライアントの返答を待つ |
|point <プレイヤー> (=\|+\|-)<点数> | |プレイヤーの点数を通知する。点数の前には必ず=\|+\|-が付き、=は点数の直指定、+-は増減を意味する |
|richi <プレイヤー> <点数>||リーチ棒を出す。点数表記はpointコマンドと同じ|
|dice <サイコロの目1> <サイコロの目2> | |サイコロの出目を送る |
|haipai <プレイヤー> <配牌> | |配牌を配る |
|open <プレイヤー> <晒した牌> [<鳴いた牌>]| |手牌を公開する(和了、流局時のテンパイ宣言、チー、ポン、カン)|
|dora <牌> <表示牌>| |ドラを送る |
|uradora <牌> <表示牌>| |裏ドラを送る |
|tsumo <プレイヤー> <残り枚数> <牌> [rinshan]||牌をツモ|
|sutehai? [richi <リーチ可能な牌>] [tsumo] [ankan] [kakan]| |捨牌を尋ねる。クライアントが可能なコマンドも送る |
| |sutehai <牌> [tsumogiri] [richi] |捨てる。ツモ切り、リーチは引数で指定する |
| |tsumo |ツモあがり |
| |ankan <牌列> |暗カン |
| |kakan <牌> |加カン|
|sutehai <プレイヤー> <牌> [tsumogiri] [richi] | |捨牌。ツモ切り、リーチは引数で指定される |
|naki? <牌> [ron] [kan] [pon] [chi] | |牌を鳴くか尋ねる。クライアントが可能なコマンドも送る |
| |no |鳴かない |
| |ron |ロン |
| |pon <牌列> |ポン |
| |chi <牌列> |チー |
| |kan <牌列> |明カン |
|say <プレイヤー> chi\|pon\|kan\|ron\|tsumo\|richi\|tenpai\|noten||発声|
|agari <プレイヤー> <点数名> <符> <役1> <ハン数1> ... | |あがり。点数名は「3900」「満貫」などの文字列 |
|ryukyoku | |流局 |
|tenpai? | |テンパイを宣言するか尋ねる |
| |tenpai |宣言する |
| |noten(tenpai以外) |宣言しない |
|\_ex_ ||拡張コマンド |

### helloコマンドのオプション

|重要度|オプション名|説明|
|:--:|:--|:--|
|◎|ump=<バージョン>|バージョン|
|○|name=<名前>|表示する名前|
|△|user=<ユーザ名>|認証用ユーザ名|
|△|password=<パスワード>|認証用パスワード|
|△|lang=<言語>|言語(ja\|en\|...)|

- ◎=必須、○=推奨、△=オプショナル
- オプション名が'_'(アンダーバー)で始まるものは、各サーバ/クライアントの実装で自由に使って良い。ただし、指定されなかった場合でもできるだけ動作するようにすること

## 補足

- 不正なコマンドを返したとき(持っていないのにponとか)の挙動は、サーバの実装次第(無視、あるいは再度尋ねる等)
- なので、状況についてはサーバから送られてきたものが絶対。クライアントがponやronを送っても、サーバが認めない限り無効
